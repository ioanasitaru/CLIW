const module_name="draw";let lastX,touchX,touchY,canvas,ctx,mouseX,mouseY,translatedWord,currentWord,initialPath,score,lastY=-1,mouseDown=0;const visited=[],scoreObj=new Score("draw");function drawLine(e,t,n,o){-1===lastX&&(lastX=t,lastY=n);e.strokeStyle="rgba(0,0,0,1)",e.lineCap="round",e.beginPath(),e.moveTo(lastX,lastY),e.lineTo(t,n),e.lineWidth=o,e.stroke(),e.closePath(),lastX=t,lastY=n}function clearCanvas(e,t){t.clearRect(0,0,e.width,e.height),t.font="bold 150px Arial",t.globalAlpha=.2,t.fillText(translatedWord,e.width/2-t.measureText(translatedWord).width/2,e.height/2+50),t.globalAlpha=1,score=0,document.getElementById("canvas").classList.remove("wrong")}function sketchpad_mouseDown(){mouseDown=1,drawLine(ctx,mouseX,mouseY,7),compareUserInput(mouseX,mouseY)}function sketchpad_mouseMove(e){getMousePos(e),1===mouseDown&&(drawLine(ctx,mouseX,mouseY,7),compareUserInput(mouseX,mouseY))}function sketchpad_mouseUp(){mouseDown=0,lastX=-1,lastY=-1,document.getElementById("canvas").classList.remove("wrong")}function getMousePos(e){e||(e=event),e.offsetX?(mouseX=e.offsetX,mouseY=e.offsetY):e.layerX&&(mouseX=e.layerX,mouseY=e.layerY)}function sketchpad_touchStart(){getTouchPos(),drawLine(ctx,touchX,touchY,7),event.preventDefault(),compareUserInput(touchX,touchY)}function sketchpad_touchEnd(){lastX=-1,lastY=-1,document.getElementById("canvas").classList.remove("wrong")}function sketchpad_touchMove(e){getTouchPos(e),drawLine(ctx,touchX,touchY,7),event.preventDefault(),compareUserInput(touchX,touchY)}function getTouchPos(e){if(!e)e=event;if(e.touches&&1===e.touches.length){const t=e.touches[0];touchX=t.pageX-t.target.offsetLeft,touchY=t.pageY-t.target.offsetTop}}function isVisited(e,t){let n;for(n=0;n<visited.length;n++)if(visited[n].X===e&visited[n].Y===t)return!0;return visited.push({X:e,Y:t}),!1}function compareUserInput(e,t){e=Math.round(e),t=Math.round(t),initialPath[4*((t-1)*canvas.width+e)+3]>0?(document.getElementById("canvas").classList.remove("wrong"),isVisited(e,t)||(score+=1)):(document.getElementById("canvas").classList.add("wrong"),isVisited(e,t)||(score-=1))}function getViewportWidth(){let e;return void 0!==window.innerWidth&&(e=window.getComputedStyle(document.getElementsByTagName("body")[0]).width),e}function init(){let e=getViewportWidth();e=Number(e.substring(0,e.indexOf("px"))),canvas=document.getElementById("canvas"),e>=496?(canvas.width=490,canvas.height=290):(canvas.width=300,canvas.height=178,document.getElementById("canvas").style.width="300px",document.getElementById("canvas").style.height="178px"),canvas.getContext&&(ctx=canvas.getContext("2d")),ctx&&(canvas.addEventListener("mousedown",sketchpad_mouseDown,!1),canvas.addEventListener("mousemove",sketchpad_mouseMove,!1),window.addEventListener("mouseup",sketchpad_mouseUp,!1),canvas.addEventListener("touchstart",sketchpad_touchStart,!1),canvas.addEventListener("touchend",sketchpad_touchEnd,!1),canvas.addEventListener("touchmove",sketchpad_touchMove,!1)),generateWord()}function generateWord(){let e=new DataService,t=e.getRandomWord(),n=new PronunciationService;e.translateText(t,e=>{navigator.onLine?n.kanjnih(e).then(function(e){document.getElementById("translation").innerText=e,currentWord=e}):(document.getElementById("translation").innerText="Not available (offline)",currentWord="Offline"),translatedWord=e;let t=150;for(ctx.font="bold "+t+"px Arial";ctx.measureText(e).width>canvas.width;)t-=10,ctx.font="bold "+t+"px Arial";ctx.font="bold "+t+"px Arial",ctx.globalAlpha=.2,ctx.fillText(e,canvas.width/2-ctx.measureText(e).width/2,canvas.height/2+t/3),score=0,initialPath=ctx.getImageData(0,0,canvas.width,canvas.height).data,ctx.globalAlpha=1})}function submitResult(){scoreObj.updateScore(parseInt(score)),document.getElementById("result").style.visibility="visible",document.getElementById("result").innerHTML="You just scored: "+score+"!",document.getElementById("translation").innerText="fetching...",setTimeout(function(){document.getElementById("result").style.visibility="hidden"},4e3),clearCanvas(canvas,ctx),canvas.width=canvas.width,generateWord()}function pronounce(){const e=new SpeechSynthesisUtterance(currentWord);e.lang="ja-JP",window.speechSynthesis.speak(e)}scoreObj.initScore();