<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#1C1D26"/>
    <link rel="manifest" href="../manifest.json">
    <link rel="apple-touch-icon" sizes="57x57" href="../img/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../img/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../img/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../img/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../img/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../img/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../img/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../img/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../img/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../img/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../img/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="../img/ms-icon-144x144.png">
    <meta name="theme-color" content="#000000">

    <title>Score</title>

    <link href="../css/about.css" rel="stylesheet">
    <link href="../css/score.css" rel="stylesheet">
    <link href="../css/index.css" rel="stylesheet">

    <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "WebPage",
      "url": "https://asle-b7a2d.firebaseapp.com/html/score.html",
      "name": "Score Page",
      "description": "Here you can see your progress throughout all the modules and share it with your friends"
    }

    </script>
</head>
<body class="landing">
<div id="page-wrapper">
    <div id="header">
        <a href="#" id="logo-link">
            <img src="../img/favicon-96x96.png" id="logo" alt="asle-logo">
        </a>
        <!--<div class="vertical-line"></div>-->
        <nav id="nav">
            <ul>
                <li><a href="../index.html" id="home">Home</a></li>
                <li>
                    <a href="index.html" id="practice">Practice</a>
                </li>
                <li><a href="score.html">Progress</a></li>
            </ul>
        </nav>
    </div>
    <div id="main" class="wrapper">
    </div>
</div>
<footer>
    <p>
        <i class="fa fa-copyright" aria-hidden="true"></i> ASLE - CLIW 2017
    </p>
</footer>
<script src="../js/html2canvas.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.8.1/firebase.js"></script>
<script>
    // Initialize Firebase
    var config = {
        apiKey: "AIzaSyBz3REZO1eComp07sU_w8bHbTyRo6yRNdg",
        authDomain: "asle-b7a2d.firebaseapp.com",
        databaseURL: "https://asle-b7a2d.firebaseio.com",
        projectId: "asle-b7a2d",
        storageBucket: "asle-b7a2d.appspot.com",
        messagingSenderId: "174054857729"
    };
    firebase.initializeApp(config);
</script>
<script src = "../js/Score.js" ></script>
<script>
    tweet = function (module_name, score, scorePlace) {
        const provider = new firebase.auth.TwitterAuthProvider();
        firebase.auth().signInWithPopup(provider).then(function (result) {
            const token = result.credential.accessToken;
            const secret = result.credential.secret;
            const user = result.user;

            const chart = document.getElementsByClassName("image fit")[scorePlace];

            html2canvas(chart).then(function (cnvs) {
                let dataUrl = cnvs.toDataURL();
                const xhr = window.XMLHttpRequest ? new XMLHttpRequest() : new ActiveXObject("Microsoft.XMLHTTP");

                xhr.open('POST', '/api/twitter');
                xhr.onreadystatechange = function () {
                    if (xhr.readyState > 3 && xhr.status === 200) {
                        // console.log(xhr.responseText);
                        let popup = document.getElementById("myPopup" + scorePlace);
                        popup.classList.toggle("show");

                        setTimeout(function () {
                            popup.classList.toggle("show");
                        }, 3000);
                    }
                };
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.send(JSON.stringify({
                    token: token,
                    secret: secret,
                    img: dataUrl.substring(22),
                    module: module_name,
                    score: score
                }));
                return xhr;
            })
                .catch(function (error) {
                    console.error('oops, something went wrong!', error);
                });

        });
    }
</script>
<script>
    String.prototype.capitalize = function () {
        return this.charAt(0).toUpperCase() + this.slice(1);
    };

    let insertingDiv = document.getElementById("main");

    let place = 0;
    fetch("../comp.json")
        .then(response => response.json())
        .then(components => {
            components.forEach((component) => {
                let score = new Score(component.name);
                let history = score.getHistory();
                if (history) {

                    let container = document.createElement("div");
                    container.className = "container";

                    let header = document.createElement("header");
                    header.className = "major";

                    let message = document.createElement("h2");
                    message.textContent = "Your stats at " + component.name.capitalize();

                    let overallPerformance = document.createElement("p");
                    overallPerformance.textContent = 'Today you scored ' + history.todayScore + '... Way to go!';

                    let twitterShare = document.createElement("p");
                    let textBefore = document.createTextNode("Share it on ");
                    let textAfter = document.createTextNode(" with your friends.");
                    let link = document.createElement("a");

                    let popup = document.createElement("span");
                    popup.className = "popuptext";
                    popup.id = "myPopup" + place;
                    popup.textContent = "Tweeted !";

                    link.setAttribute("href", "javascript:void(0)");
                    link.className = "twitter";
                    link.addEventListener("click", function () {
                        tweet(component.name, history.todayScore, place);
                        place++;
                    });
                    link.textContent = "Twitter";
                    let twitterIcon = document.createElement("i");
                    twitterIcon.className = "fa fa-twitter";
                    twitterIcon.setAttribute("aria-hidden", "true");

                    link.appendChild(twitterIcon);

                    twitterShare.className = "popup";
                    twitterShare.appendChild(textBefore);
                    twitterShare.appendChild(link);
                    twitterShare.appendChild(textAfter);
                    twitterShare.appendChild(popup);

                    // console.log(twitterShare);

                    header.appendChild(message);
                    header.appendChild(overallPerformance);
                    header.appendChild(twitterShare);
                    container.appendChild(header);


                    let statsSection = document.createElement("section");
                    statsSection.id = "content2";

                    let title = document.createElement("h3");
                    title.textContent = "Last week performance:";

                    let progress = document.createElement("h5");
                    progress.textContent = history.streak + " of maximum streak of " + history.maxStreak;

                    let currentStreak = document.createElement("h3");
                    currentStreak.textContent = "Current streak";

                    let progressBar = document.createElement("div");
                    progressBar.className = "progress-bar";

                    let pBar = document.createElement("div");
                    pBar.className = "pBar";
                    let width = 1;
                    let id = setInterval(frame, 10);

                    function frame() {
                        if (history.streak === 0 || width >= (history.streak / history.maxStreak) * 100) {
                            clearInterval(id);
                        } else {
                            width++;
                            pBar.style.width = width + '%';
                        }
                    }

                    let linkChart = document.createElement("a");
                    linkChart.className = "image fit";
                    linkChart.setAttribute("href", "#");

                    let chart = document.createElement("div");
                    let chartjson = {
                        "title": "",
                        "data": [{
                            "name": "Monday",
                            "score": history.monday
                        }, {
                            "name": "Tuesday",
                            "score": history.tuesday
                        }, {
                            "name": "Wednesday",
                            "score": history.wednesday
                        }, {
                            "name": "Thursday",
                            "score": history.thursday
                        },
                            {
                                "name": "Friday",
                                "score": history.friday
                            }, {
                                "name": "Saturday",
                                "score": history.saturday
                            }, {
                                "name": "Sunday",
                                "score": history.sunday
                            }],
                        "ymax": Math.max(history.monday, history.tuesday, history.wednesday, history.thursday, history.friday, history.saturday, history.sunday),
                        "ykey": 'score',
                        "xkey": "name",
                        "prefix": "%"
                    };

                    //chart colors
                    let colors = ['five', 'five', 'five', 'five', 'five', 'five', 'five'];

                    //constants
                    let TROW = 'tr',
                        TDATA = 'td';

                    //create the chart draw
                    let barchart = document.createElement('table');
                    chart.appendChild(barchart);

                    //create the bar row
                    let barrow = document.createElement(TROW);
                    barrow.setAttribute('class', 'bars');

                    //lets add data to the chart
                    for (let i = 0; i < chartjson.data.length; i++) {
                        let prefix = '';
                        //create the bar data
                        let bardata = document.createElement(TDATA);
                        let bar = document.createElement('div');
                        bar.setAttribute('class', 'bar ' + colors[i]);
                        bar.style.height = (chartjson.data[i][chartjson.ykey] / chartjson.ymax) * 80 + "%";
                        bardata.innerText = chartjson.data[i][chartjson.ykey] + prefix;
                        bardata.appendChild(bar);

                        let legbox = document.createElement('span');
                        legbox.setAttribute('class', 'legbox');
                        bardata.appendChild(legbox);
                        let bartext = document.createElement('span');
                        bartext.innerText = chartjson.data[i][chartjson.xkey];
                        legbox.appendChild(bartext);

                        barrow.appendChild(bardata);
                    }

                    barchart.appendChild(barrow);
                    chart.appendChild(barchart);

                    linkChart.appendChild(chart);
                    progressBar.appendChild(pBar);

                    statsSection.appendChild(title);
                    statsSection.appendChild(currentStreak);
                    statsSection.appendChild(progressBar);
                    statsSection.appendChild(progress);
                    statsSection.appendChild(linkChart);


                    insertingDiv.appendChild(container);
                    insertingDiv.appendChild(statsSection);
                }
            });
        });
</script>

<script>
    if ('serviceWorker' in navigator) {
        // console.log("Beam me up");
        navigator.serviceWorker
            .register('/service-worker.js')
            .then(function () {
                // console.log("Service Worker Registered");
            });
    }
</script>
<!--<script src="https://use.fontawesome.com/734f4e0645.js"></script>-->
</body>
</html>